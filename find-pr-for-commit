#!/usr/bin/env bash

# Usage: ./find-pr-for-commit [PROJECT] SHA
#
# Authors: Fabio Rehm, Mislav MarohniÄ‡

set -e

PROJECT=
COMMIT=

project-from-remote() {
  git remote get-url "${1?}" | \
    grep -o 'github\.com[/:].\+' | \
    sed 's/github\.com.//; s/\.git$//'
}

if [ $# -eq 1 ]; then
  PROJECT="$(project-from-remote origin)"
  COMMIT="${1}"
  shift 1
elif [ $# -ge 2 ]; then
  PROJECT="${1}"
  COMMIT="${2}"
  shift 2
else
  echo "Usage: hub-pr-with-commit [PROJECT] SHA"
  exit 1
fi

hub api graphql -f q="${COMMIT} type:pr repo:${PROJECT}" "$@" -f query='
  query($q: String!) {
    search(query: $q, type: ISSUE, first: 3) {
      nodes {
        ... on PullRequest {
          url
          title
        }
      }
    }
  }
' | jq -r '.data.search.nodes[] | "\(.url) - \(.title)"'
